<!-- BEGIN DASHBOARD BUILD -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Write-Off Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
  <!-- Page Title -->
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Write-Off Dashboard</h1>

  <!-- Date Range Selector -->
  <div class="mb-6 space-y-2">
    <div class="flex items-center space-x-4">
      <label class="text-sm">Start Date:</label>
      <input type="date" id="startDate" class="border rounded px-2 py-1" />
      <label class="text-sm">End Date:</label>
      <input type="date" id="endDate" class="border rounded px-2 py-1" />
      <button onclick="loadWriteoffData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
        Load Writeoff Data
      </button>
      <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
        Export to CSV
      </button>
    </div>
    <div id="dateWarning" class="text-red-600 text-sm hidden">
      ‚ö†Ô∏è Up to 12 months of data <span class="italic">may</span> be exported. It is safest to keep data pulls under 6 months when possible.
    </div>
  </div>

  <!-- Writeoff Container -->
  <div id="writeoff-container" class="space-y-6"></div>

  <!-- Main Script Block -->
  <script>
    // ========== MOCK WRITE-OFF DATA ==========
    const writeoffData = [
      {
        writeoffId: "WR-1001",
        total: 324.65,
        date: "2024-08-21",
        reason: "System Error",
        invoices: [
          {
            invoiceId: "INV-101",
            customer: "Acme Corp",
            amount: 200.45,
            items: [
              { description: "Phone Line", amount: 100.25 },
              { description: "Voicemail Add-on", amount: 100.20 },
            ],
          },
          {
            invoiceId: "INV-102",
            customer: "Acme Corp",
            amount: 124.20,
            items: [
              { description: "Toll-Free Number", amount: 124.20 },
            ],
          },
        ],
      },
      {
        writeoffId: "WR-1002",
        total: 75.00,
        date: "2024-08-29",
        reason: "Customer Satisfaction",
        invoices: [
          {
            invoiceId: "INV-200",
            customer: "Beta Inc",
            amount: 75.00,
            items: [
              { description: "Service Fee", amount: 75.00 },
            ],
          },
        ],
      },
    ];

    // ========== WRITE-OFF TABLE BUILDER ==========
    function buildWriteoffTable(data) {
      const container = document.getElementById("writeoff-container");
      container.innerHTML = "";

      data.forEach((writeoff) => {
        const section = document.createElement("div");
        section.className = "bg-white rounded shadow p-4 space-y-2 border";

        const summary = document.createElement("div");
        summary.className = "flex justify-between items-center font-medium";
        summary.innerHTML = `
          <div>
            <div class="text-lg text-orange-700 font-bold">${writeoff.writeoffId}</div>
            <div class="text-sm text-gray-600">${writeoff.reason} ‚Ä¢ ${writeoff.date}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-600">Total</div>
            <div class="text-xl font-bold text-blue-800">$${writeoff.total.toFixed(2)}</div>
          </div>
        `;
        section.appendChild(summary);

        const invoiceTable = document.createElement("table");
        invoiceTable.className = "w-full text-sm border-t mt-2";

        let tableHTML = `
          <thead>
            <tr class="bg-gray-100 text-left">
              <th class="p-2">Invoice ID</th>
              <th class="p-2">Customer</th>
              <th class="p-2">Charge Description</th>
              <th class="p-2 text-right">Amount</th>
            </tr>
          </thead>
          <tbody>
        `;

        writeoff.invoices.forEach((inv) => {
          inv.items.forEach((item, idx) => {
            tableHTML += `
              <tr class="border-t">
                <td class="p-2">${idx === 0 ? inv.invoiceId : ""}</td>
                <td class="p-2">${idx === 0 ? inv.customer : ""}</td>
                <td class="p-2">${item.description}</td>
                <td class="p-2 text-right">$${item.amount.toFixed(2)}</td>
              </tr>
            `;
          });
        });

        tableHTML += "</tbody></table>";
        invoiceTable.innerHTML = tableHTML;
        section.appendChild(invoiceTable);
        container.appendChild(section);
      });
    }

    // ========== CSV EXPORT ==========
    function exportCSV() {
      let csv = "Writeoff ID,Date,Reason,Invoice ID,Customer,Description,Amount\n";

      writeoffData.forEach(w => {
        w.invoices.forEach(inv => {
          inv.items.forEach(item => {
            csv += `${w.writeoffId},${w.date},${w.reason},${inv.invoiceId},${inv.customer},${item.description},${item.amount.toFixed(2)}\n`;
          });
        });
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "writeoff_data.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ========== LOAD + VALIDATE DATE RANGE ==========
    function loadWriteoffData() {
      const startInput = document.getElementById("startDate").value;
      const endInput = document.getElementById("endDate").value;
      const warning = document.getElementById("dateWarning");

      if (!startInput || !endInput) {
        alert("Please select both a start and end date.");
        return;
      }

      const startDate = new Date(startInput);
      const endDate = new Date(endInput);

      if (startDate > endDate) {
        alert("Start date must be before end date.");
        return;
      }

      const oneDay = 1000 * 60 * 60 * 24;
      const dayDiff = Math.round((endDate - startDate) / oneDay);

      if (dayDiff > 365) {
        alert("Maximum date range is 365 days.");
        return;
      }

      if (dayDiff > 183) {
        warning.classList.remove("hidden");
      } else {
        warning.classList.add("hidden");
      }

      // üîß TODO: Replace with real n8n POST call
      console.log("üöÄ Load writeoff data for:", { startDate: startInput, endDate: endInput });

      buildWriteoffTable(writeoffData);
    }
  </script>
</body>
</html>

