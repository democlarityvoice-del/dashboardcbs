<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Write-Off Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --clarity-orange: #ef8607; /* Clarity Portal Orange */
    }
    .bg-clarity-orange {
      background-color: var(--clarity-orange);
    }
    .hover\:bg-clarity-orange-dark:hover {
      background-color: #d67605;
    }
    .text-clarity-orange {
      color: var(--clarity-orange);
    }
    .border-clarity-orange {
      border-color: var(--clarity-orange);
    }
    </style>
  
    <style>
    /* DARK MODE */
    body.dark-mode {
      background-color: #1f2937;
      color: #f3f4f6;
    }
  
    body.dark-mode aside {
      background-color: #111827;
    }
  
    body.dark-mode .bg-white,
    body.dark-mode #totalAmountCard {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
    }
  
    body.dark-mode table th {
      background-color: #374151 !important;
      color: #f3f4f6 !important;
    }
  
    body.dark-mode table td {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
    }
  
    body.dark-mode table tr:hover td {
      background-color: #4b5563 !important;
    }
  </style>

</head>
<body class="bg-gray-100 font-sans">
  <div class="flex">
    
    <!-- SIDEBAR -->
    <aside class="w-64 bg-gray-900 text-white min-h-screen">
      <div class="p-4 text-lg font-bold bg-clarity-orange">Dashboard Menu</div>
      <nav class="mt-4">
        <a href="#" class="block py-2 px-4 hover:bg-gray-700">Writeoffs Data Dashboard</a>
        <a href="#" class="block py-2 px-4 hover:bg-gray-700">Lost Revenue Data Dashboard</a>
        <a href="#" class="block py-2 px-4 hover:bg-gray-700">Merged Analysis Dashboard</a>
        <a href="#" class="block py-2 px-4 hover:bg-gray-700">Settings</a>
      </nav>
      <div class="absolute bottom-4 left-4 text-xs text-gray-400">© 2025 Clarity</div>
    </aside>


    <!-- MAIN CONTENT -->
    <main class="flex-1 p-6">
      <h1 class="text-2xl font-bold mb-6">Write-Off Dashboard</h1>

      <!-- DATE SELECTOR + LOAD BUTTON -->
      <div class="flex items-end gap-4 mb-6">
        <div>
          <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
          <input type="date" id="startDate" class="mt-1 block w-48 border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div>
          <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
          <input type="date" id="endDate" class="mt-1 block w-48 border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <button id="loadBtn"
          class="bg-white border border-gray-300 shadow-md hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-md transition">
          Load Write-Offs
        </button>


      </div>
      
      <!-- TOTAL + EXPORT + DARK MODE TOGGLE -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-4">
          
      <!-- Export CSV -->
      <button id="exportBtn" 
         class="bg-white border border-gray-300 shadow-md hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-md transition">
        Export CSV
      </button>
      
      <!-- Dark Mode Toggle -->
      <button id="darkModeToggle" 
        class="bg-white border border-gray-300 shadow-md hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-md transition">
        Dark Mode
      </button>

        </div>
      
        <!-- Total Write-Offs -->
        <div class="bg-[#ef8607] hover:bg-[#d67605] text-white px-4 py-2 rounded-md shadow-md transition">
          <p class="text-gray-500 text-sm">Total Write-Offs for Time Period</p>
          <p id="totalAmount" class="text-2xl font-bold">$0.00</p>
        </div>
      </div>





<!-- MAIN WRITE-OFF TABLE -->
      <div class="shadow-md rounded-md overflow-hidden mb-8">
        <table class="table-fixed w-full border-collapse">
          <thead>
            <tr class="bg-[#EDEEEF] text-left">
              <th class="px-4 py-2 w-[15%]">Customer ID</th>
              <th class="px-4 py-2 w-[20%]">Customer Name</th>
              <th class="px-4 py-2 w-[15%]">Write-Off ID</th>
              <th class="px-4 py-2 w-[15%]">Reference</th>
              <th class="px-4 py-2 w-[15%]">Date</th>
              <th class="px-4 py-2 w-[10%] text-right">Write-Off Total</th>
              <th class="px-4 py-2 w-[10%] text-right">Invoices</th>
            </tr>
          </thead>
          <!-- JS will dynamically populate rows here -->
          <tbody id="writeoffTable"></tbody>
        </table>
      </div>

    </main>
  </div>

    <!-- Layout & Sidebar Spacing Fix -->
    <script>
      const aside = document.querySelector('aside');
      if (aside) aside.style.paddingTop = '20px';

      document.querySelectorAll('aside nav a').forEach(link => {
        link.style.marginBottom = '8px';
      });

      const footer = document.querySelector('aside .absolute');
      if (footer) {
        footer.style.left = '50%';
        footer.style.transform = 'translateX(-50%)';
        footer.style.textAlign = 'center';
      }

      const main = document.querySelector('main');
      if (main) main.style.marginTop = '20px';

      const filterSection = document.querySelector('.flex.items-end.gap-4');
      if (filterSection) {
        filterSection.style.marginBottom = '20px';
        filterSection.style.gap = '16px';
        if (!filterSection.dataset.styled) {
          filterSection.style.backgroundColor = '#f9fafb';
          filterSection.style.padding = '10px';
          filterSection.style.borderRadius = '6px';
          filterSection.style.border = '1px solid #e5e7eb';
          filterSection.dataset.styled = 'true';
        }
      }
    </script>


  
  <script>
    
    // --- REAL MASKED DATA ---
    const writeoffs = [
      {
        customer_name: "Ok City",
        customer_id: 123264,
        writeoff_id: 914286,
        reference_id: "WO-KR-CR",
        writeoff_date: "2025-09-01 15:48:28",
        writeoff_amount: "72.85",
        invoices: [
          {
            invoice_id: 1330366,
            invoice_writeoff_amount: "33.38",
            invoice_date: "2025-06-01 03:39:48",
            items: [
              { description: "State & Local Taxes", item_count: 1 },
              { description: "Yealink W76P DECT Base+Handset DaaS", item_count: 1 },
              { description: "WatchDog Entry RRT-200 DaaS Discount", item_count: 1 },
              { description: "DaaS Yealink - T54W - AC", item_count: 1 }
            ]
          },
          {
            invoice_id: 1330665,
            invoice_writeoff_amount: "39.47",
            invoice_date: "2025-06-30 20:52:04",
            items: [
              { description: "Return Label phones", item_count: 1 },
              { description: "State & Local Taxes", item_count: 1 }
            ]
          }
        ]
      },
      {
        customer_name: "Michigan Wisconsin",
        customer_id: 125451,
        writeoff_id: 914301,
        reference_id: "9.2.25",
        writeoff_date: "2025-09-02 16:20:06",
        writeoff_amount: "1224.30",
        invoices: [
          {
            invoice_id: 1319479,
            invoice_writeoff_amount: "204.09",
            invoice_date: "2025-04-01 01:36:02",
            items: [
              { description: "Federal Universal Service", item_count: 1 },
              { description: "Telephone Number", item_count: 1 },
              { description: "State and local fees", item_count: 1 },
              { description: "Federal Recovery Fee (PP)", item_count: 1 },
              { description: "Essentials 20% | $10.00 Term Discount", item_count: 1 },
              { description: "Compliance Cost Recovery Fee", item_count: 1 },
              { description: "Essentials", item_count: 1 },
              { description: "Poly Edge E220 AC DaaS", item_count: 1 },
              { description: "e911 Service Fee", item_count: 1 },
              { description: "EFAX Service", item_count: 1 },
              { description: "State & Local Taxes", item_count: 1 }
            ]
          },
          {
            invoice_id: 1323450,
            invoice_writeoff_amount: "204.09",
            invoice_date: "2025-05-01 01:23:09",
            items: [
              { description: "State & Local Taxes", item_count: 1 },
              { description: "Federal Universal Service", item_count: 1 },
              { description: "Telephone Number", item_count: 1 },
              { description: "State and local fees", item_count: 1 },
              { description: "Federal Recovery Fee (PP)", item_count: 1 },
              { description: "Essentials 20% | $10.00 Term Discount", item_count: 1 },
              { description: "Compliance Cost Recovery Fee", item_count: 1 },
              { description: "Essentials", item_count: 1 },
              { description: "Poly Edge E220 AC DaaS", item_count: 1 },
              { description: "e911 Service Fee", item_count: 1 },
              { description: "EFAX Service", item_count: 1 }
            ]
          }
        ]
      }
    ];

    const tableBody = document.getElementById("writeoffTable");
    const totalAmountEl = document.getElementById("totalAmount");
      
    function formatCurrency(amount) {
        return `$${parseFloat(amount).toFixed(2)}`;
      }

        // Dark Mode Toggle
    document.getElementById("darkModeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

      
      function renderTable() {
        tableBody.innerHTML = "";
        let grandTotal = 0;
      
        writeoffs.forEach((writeoff, index) => {
          grandTotal += parseFloat(writeoff.writeoff_amount);
      
          // Totals validation
          const calculatedTotal = writeoff.invoices.reduce((sum, inv) => sum + parseFloat(inv.invoice_writeoff_amount), 0);
          if (Math.abs(calculatedTotal - parseFloat(writeoff.writeoff_amount)) > 0.01) {
            console.warn(
              `⚠️ Write-Off ${writeoff.writeoff_id} mismatch: Backend ${writeoff.writeoff_amount}, Calculated ${calculatedTotal}`
            );
          }
      
          // --- Main Row ---
          const row = document.createElement("tr");
          row.className =
            index % 2 === 0
              ? "bg-white hover:bg-[#F4F5F7] border-b"
              : "bg-[#FAFAFA] hover:bg-[#F4F5F7] border-b";
      
          row.innerHTML = `
            <td class="py-2 px-4">${writeoff.customer_id}</td>
            <td class="py-2 px-4">${writeoff.customer_name}</td>
            <td class="py-2 px-4">${writeoff.writeoff_id}</td>
            <td class="py-2 px-4">${writeoff.reference_id}</td>
            <td class="py-2 px-4">${writeoff.writeoff_date.split(" ")[0]}</td>
            <td class="py-2 px-4 text-right">${formatCurrency(writeoff.writeoff_amount)}</td>
            <td class="py-2 px-4 text-center">
              <button class="toggle-btn text-[#ef8607] underline" data-id="${writeoff.writeoff_id}">
                ${writeoff.invoices.length} ${writeoff.invoices.length === 1 ? "Invoice" : "Invoices"}
              </button>
            </td>
          `;
          tableBody.appendChild(row);
      
          // --- Hidden Invoice Details Row ---
          const invoiceRow = document.createElement("tr");
          invoiceRow.className = "hidden";
          invoiceRow.setAttribute("data-parent", writeoff.writeoff_id);
      
          let invoiceHTML = `
            <td colspan="7" class="p-4">
              <div class="shadow-lg rounded-md overflow-hidden">
                <table class="w-full table-fixed border-collapse">
                  <thead>
                    <tr class="bg-[#F4F5F7]">
                      <th class="py-2 px-4 text-left w-[20%]">Invoice ID</th>
                      <th class="py-2 px-4 text-left w-[15%]">Date</th>
                      <th class="py-2 px-4 text-left w-[50%]">Description</th>
                      <th class="py-2 px-4 text-right w-[15%]">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
      
          writeoff.invoices.forEach((inv, idx) => {
            const invoiceUrl = `https://cbs.clarityvoice.com/billing/viewinv.php?id=${inv.invoice_id}`;
            const descriptionList = inv.items
              .map((item) => `<li>${item.description} (${item.item_count})</li>`)
              .join("");
      
            const rowClass = idx % 2 === 0 ? "bg-white hover:bg-[#F4F5F7]" : "bg-[#FAFAFA] hover:bg-[#F4F5F7]";
      
            invoiceHTML += `
              <tr class="${rowClass}">
                <td class="py-2 px-4">
                  <a href="${invoiceUrl}" target="_blank" class="text-[#ef8607] underline">${inv.invoice_id}</a>
                </td>
                <td class="py-2 px-4">${inv.invoice_date.split(" ")[0]}</td>
                <td class="py-2 px-4"><ul>${descriptionList}</ul></td>
                <td class="py-2 px-4 text-right">${formatCurrency(inv.invoice_writeoff_amount)}</td>
              </tr>
            `;
          });
      
          // Close the invoice table
          invoiceHTML += `
                  </tbody>
                </table>
              </div>
            </td>
          `;
      
          invoiceRow.innerHTML = invoiceHTML;
          tableBody.appendChild(invoiceRow);
        });
      
        // Update total
        totalAmountEl.textContent = formatCurrency(grandTotal);
      
      // Toggle logic
      document.querySelectorAll(".toggle-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const parentId = btn.getAttribute("data-id");
          const invoiceRow = document.querySelector(`[data-parent="${parentId}"]`);
          if (invoiceRow) {
            invoiceRow.classList.toggle("hidden");
          }
        });
      });


      }

    


    // Export CSV
    document.getElementById("exportBtn").addEventListener("click", () => {
      let csv = "Customer ID,Customer Name,Write-Off ID,Reference,Date,Total\n";
      writeoffs.forEach(w => {
        csv += `${w.customer_id},${w.customer_name},${w.writeoff_id},${w.reference_id},${w.writeoff_date},${w.writeoff_amount}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "writeoffs.csv";
      link.click();
    });

    // Initial render
    document.getElementById("loadBtn").addEventListener("click", renderTable);
    renderTable();
  </script>
</body>
</html>
