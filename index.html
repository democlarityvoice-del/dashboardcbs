<!-- BEGIN DASHBOARD BUILD -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writeoff Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div class="flex h-screen">

    <!-- Sidebar Menu-->
    <aside class="w-64 bg-white shadow-lg p-4 space-y-4">
      <h1 class="text-xl font-bold text-orange-600">Clarity Dashboard</h1>
      <nav class="flex flex-col space-y-2">
        <button onclick="switchTab('writeoffs')" class="text-left px-2 py-1 rounded hover:bg-orange-100" id="btn-writeoffs">Writeoffs</button>
        <button onclick="switchTab('lostrevenue')" class="text-left px-2 py-1 rounded hover:bg-orange-100" id="btn-lostrevenue">Lost Revenue</button>
        <button onclick="switchTab('comparison')" class="text-left px-2 py-1 rounded hover:bg-orange-100" id="btn-comparison">Merged Analysis</button>
      </nav>
    </aside>

   <!-- Date Range Selector -->
<div class="mb-6 space-y-2">
  <div class="flex items-center space-x-4">
    <label class="text-sm">Start Date:</label>
    <input type="date" id="startDate" class="border rounded px-2 py-1" />
    <label class="text-sm">End Date:</label>
    <input type="date" id="endDate" class="border rounded px-2 py-1" />
    <button onclick="loadWriteoffData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
      Load Writeoff Data
    </button>
  </div>
  <div id="dateWarning" class="text-red-600 text-sm hidden">
    ⚠️ Up to 12 months of data <span class="italic">may</span> be exported. It is safest to keep data pulls under 6 months when possible.
  </div>
</div>


      
      <!-- Main Content Writeoff Section-->
      <main class="flex-1 overflow-y-auto p-6">
        <div id="tab-writeoffs">
          <!-- Top Header: Title + Export -->
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Writeoffs</h2>
            <button onclick="exportCSV()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow">
              Export CSV
            </button>
          </div>
      
          <!-- Date Range + Load Button -->
          <div class="mb-6">
            <div class="flex items-center flex-wrap gap-4">
              <label class="text-sm font-medium">Start Date:</label>
              <input type="date" id="startDate" class="border rounded px-2 py-1" />
              <label class="text-sm font-medium">End Date:</label>
              <input type="date" id="endDate" class="border rounded px-2 py-1" />
              <button onclick="loadWriteoffData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
                Load Writeoff Data
              </button>
            </div>
            <div id="dateWarning" class="mt-2 text-orange-700 text-sm hidden">
              ⚠️ Up to 12 months of data <span class="italic">may</span> be exported.
              It is safest to keep data pulls under 6 months when possible.
            </div>
          </div>
      
          <!-- Writeoff Entries Will Load Here -->
          <div id="writeoff-container" class="space-y-4"></div>
        </div>
      
        <!-- Placeholder Tabs -->
        <div id="tab-lostrevenue" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Lost Revenue</h2>
          <p>Coming soon...</p>
        </div>
        <div id="tab-comparison" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Merged Analysis</h2>
          <p>Coming soon...</p>
        </div>
      </main>
      
      <script>
        function loadWriteoffData() {
          const startInput = document.getElementById("startDate").value;
          const endInput = document.getElementById("endDate").value;
          const warning = document.getElementById("dateWarning");
      
          if (!startInput || !endInput) {
            alert("Please select both a start and end date.");
            return;
          }
      
          const startDate = new Date(startInput);
          const endDate = new Date(endInput);
      
          if (startDate > endDate) {
            alert("Start date must be before end date.");
            return;
          }
      
          const oneDay = 1000 * 60 * 60 * 24;
          const dayDiff = Math.round((endDate - startDate) / oneDay);
      
          if (dayDiff > 365) {
            alert("Maximum date range is 365 days.");
            return;
          }
      
          if (dayDiff > 183) {
            warning.classList.remove("hidden");
          } else {
            warning.classList.add("hidden");
          }
      
          // This is where your future POST to n8n will go
          console.log("Ready to POST this date range to n8n:", {
            start: startInput,
            end: endInput
          });
        }
      
        function exportCSV() {
          // Placeholder for export logic – assumed you’ll hook this to your existing writeoffData array
          alert("CSV Export triggered (hook this up to your table data)!");
        }
      </script>


        <div id="writeoff-container" class="space-y-4"></div>
      </div>

      <div id="tab-lostrevenue" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Lost Revenue</h2>
        <p>Coming soon...</p>
      </div>

      <div id="tab-comparison" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Merged Analysis</h2>
        <p>Coming soon...</p>
      </div>
    </main>
  </div>

  <script>

// ========== Mock Writeoff Data ==========
    const writeoffData = [
  {
    customer_name: "Demo Client A",
    customer_id: "000123",
    writeoff_id: "WO-10001",
    reference_id: "Adjustment - Services",
    writeoff_date: "2025-09-01",
    writeoff_amount: "99.99",
    invoices: [
      {
        invoice_id: 111222,
        invoice_writeoff_amount: "50.00",
        invoice_date: "2025-08-15",
        items: [
          { description: "Monthly Service Fee", item_count: 1 },
          { description: "Tax Adjustment", item_count: 1 }
        ]
      }
    ]
  }
];

// ======== Tab Switching ========

    function switchTab(tab) {
      document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add("hidden"));
      document.querySelector(`#tab-${tab}`).classList.remove("hidden");
    }


   

    
// ======== Writeoff Table Builder ========
    function buildWriteoffTable() {
      const container = document.getElementById("writeoff-container");
      writeoffData.forEach((record, index) => {
        const section = document.createElement("div");
        section.className = "bg-white shadow rounded p-4";

        // Top-level writeoff summary
        section.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-semibold text-lg text-orange-700">${record.customer_name}</div>
              <div class="text-sm text-gray-600">${record.customer_id} • Writeoff ID: ${record.writeoff_id}</div>
              <div class="text-sm text-gray-600">Writeoff Date: ${record.writeoff_date}</div>
              <div class="text-sm text-gray-600">Comment: ${record.reference_id}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500">Total Writeoff:</div>
              <div class="text-xl font-bold text-red-600">$${record.writeoff_amount}</div>
              <button class="text-sm text-blue-600 mt-2" onclick="toggleDetails(${index})">Toggle Invoices</button>
            </div>
          </div>
          <div id="details-${index}" class="hidden mt-4 border-t pt-4">
            ${record.invoices.map(inv => `
              <div class="mb-4">
                <div class="font-semibold">Invoice #${inv.invoice_id} - $${inv.invoice_writeoff_amount} on ${inv.invoice_date}</div>
                <div class="ml-4 text-sm">
                  ${inv.items.map(it => `<div>• ${it.description} (${it.item_count})</div>`).join("")}
                  <div class="mt-1">
                    <a href="https://cbs.clarityvoice.com/billing/viewinv.php?id=${inv.invoice_id}" target="_blank" class="text-blue-500 underline">View Invoice</a>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        container.appendChild(section);
      });
    }

 // ======== Expand/Collapse Logic ========
    function toggleDetails(index) {
      const el = document.getElementById(`details-${index}`);
      el.classList.toggle("hidden");
    }

// ======== CSV Export Logic ========
    document.addEventListener("DOMContentLoaded", buildWriteoffTable);
function exportCSV() {
  let csv = "CBS Account Name,Account Number,Writeoff ID,Writeoff Comment,Writeoff Date,Total Writeoff Amount\\n";
  writeoffData.forEach(w => {
    csv += `"${w.customer_name}","${w.customer_id}","${w.writeoff_id}","${w.reference_id}","${w.writeoff_date}","${w.writeoff_amount}"\\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "writeoffs_export.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ======== Writeoff POST Request Logic========
function loadWriteoffData() {
  const start = new Date(document.getElementById("startDate").value);
  const end = new Date(document.getElementById("endDate").value);
  const warning = document.getElementById("dateWarning");

  if (isNaN(start) || isNaN(end)) {
    alert("Please select both start and end dates.");
    return;
  }

  const diffInDays = Math.floor((end - start) / (1000 * 60 * 60 * 24));

  if (diffInDays > 183) {
    warning.classList.remove("hidden");
  } else {
    warning.classList.add("hidden");
  }

  if (diffInDays > 365) {
    alert("Date range cannot exceed 365 days.");
    return;
  }

  console.log("Eventually sending request to n8n with:", {
    startDate: start.toISOString(),
    endDate: end.toISOString()
  });

  // Later this becomes: fetch("/your-n8n-endpoint", { method: "POST", body: ... })
}

    
    
  </script>
</body>
</html>


